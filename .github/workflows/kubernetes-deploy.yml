name: CI/CD Pipeline

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push SQL Server
        working-directory: ./sql-scripts
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/sql-server:github .
          docker push ${{ secrets.DOCKER_USERNAME }}/sql-server:github

      - name: Build and Push Email Service
        working-directory: ./ShowcaseRVHub.Email
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/email:github .
          docker push ${{ secrets.DOCKER_USERNAME }}/email:github

      - name: Build and Push React App
        working-directory: ./ShowcaseRVHub.React/rv-email-service
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/react:github .
          docker push ${{ secrets.DOCKER_USERNAME }}/react:github

      - name: Build and Push Express.js Server
        working-directory: ./ShowcaseRVHub.React/server
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/express:github .
          docker push ${{ secrets.DOCKER_USERNAME }}/express:github

      - name: Build and Push WebApi Service
        working-directory: ./ShowcaseRVHub.WebApi
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/webapi:github .
          docker push ${{ secrets.DOCKER_USERNAME }}/webapi:github

      - name: Authenticate with AKS
        uses: azure/aks-set-context@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          cluster-name: showcaseRVHub-cluster
          resource-group: rg-DevOps-Pipelines

      - name: Debug Info
        run: |
          kubectl config view
          kubectl cluster-info

      # - name: Test AKS cluster reachability
      #   run: |
      #     az login
      #     az aks get-credentials --resource-group rg-DevOps-Pipelines --name showcaseRVHub-cluster

      - name: Debug Environment
        run: |
          echo "AZURE_CREDENTIALS: $AZURE_CREDENTIALS"
          echo "KUBECONFIG: $KUBECONFIG"
        
      - name: Print Kubeconfig
        run: |
          cat $KUBECONFIG

      - name: Debug Networking
        run: |
          ip route
          sudo apt install traceroute
          sudo apt install inetutils-traceroute
          traceroute showcaserv-rg-devops-pipeli-750501-srcaa6ih.hcp.westus2.azmk8s.io        
        
      - name: Deploy to AKS
        run: |          
          kubectl config current-context
          for i in {1..3}; do
            az aks get-credentials --resource-group rg-DevOps-Pipelines --name showcaseRVHub-cluster --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            kubectl apply -f ./k8s-config/kubeconfig.yaml --server=${{ secrets.AKS_CLUSTER_ENDPOINT }} --username _ --password ${{ secrets.AZURE_CLIENT_SECRET }}
            sleep 15
          done

        # services:
          #   sql-server:
          #     image: mcr.microsoft.com/mssql/server:latest
          #     env:
          #       SA_PASSWORD: "5p3ctrum!"
          #       ACCEPT_EULA: "Y"
          #     ports:
          #       - "1433:1433"
          #     volumes:
          #       - ./sql-scripts:/docker-entrypoint-initdb.d
          #     options: --name sql-server